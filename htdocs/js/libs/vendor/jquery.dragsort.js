// jQuery List DragSort v0.5.1
// Website: http://dragsort.codeplex.com/
// License: http://dragsort.codeplex.com/license
!function(e){e.fn.dragsort=function(t){if("destroy"==t)return e(this.selector).trigger("dragsort-uninit"),void 0
    var r=e.extend({},e.fn.dragsort.defaults,t),o=[],a=null,i=null
    return this.each(function(t,d){e(d).is("table")&&1==e(d).children().size()&&e(d).children().is("tbody")&&(d=e(d).children().get(0))
        var l={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:d,init:function(){r.tagName=0==e(this.container).children().size()?"li":e(this.container).children().get(0).tagName.toLowerCase(),""==r.itemSelector&&(r.itemSelector=r.tagName),""==r.dragSelector&&(r.dragSelector=r.tagName),""==r.placeHolderTemplate&&(r.placeHolderTemplate="<"+r.tagName+">&nbsp;</"+r.tagName+">"),e(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var t=o[e(this).attr("data-listidx")]
            e(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit"),t.styleDragHandlers(!1)},getItems:function(){return e(this.container).children(r.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return e(this).is(r.dragSelector)?this:e(this).find(r.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){var a=o[e(this).attr("data-listidx")],i=e(t.target).closest("[data-listidx] > "+r.tagName).get(0),d=a.getItems().filter(function(){return this==i}).size()>0
            if(!(1!=t.which||e(t.target).is(r.dragSelectorExclude)||e(t.target).closest(r.dragSelectorExclude).size()>0)&&d){t.preventDefault()
                for(var l=t.target;!e(l).is(r.dragSelector);){if(l==this)return
                    l=l.parentNode}e(l).attr("data-cursor",e(l).css("cursor")),e(l).css("cursor","move")
                var n=this,s=function(){a.dragStart.call(n,t),e(a.container).unbind("mousemove",s)}
                e(a.container).mousemove(s).mouseup(function(){e(a.container).unbind("mousemove",s),e(l).css("cursor",e(l).attr("data-cursor"))})}},dragStart:function(t){null!=a&&null!=a.draggedItem&&a.dropItem(),a=o[e(this).attr("data-listidx")],a.draggedItem=e(t.target).closest("[data-listidx] > "+r.tagName),a.draggedItem.attr("data-origpos",e(this).attr("data-listidx")+"-"+e(a.container).children().index(a.draggedItem))
            var i=parseInt(a.draggedItem.css("marginTop")),d=parseInt(a.draggedItem.css("marginLeft"))
            if(a.offset=a.draggedItem.offset(),a.offset.top=t.pageY-a.offset.top+(isNaN(i)?0:i)-1,a.offset.left=t.pageX-a.offset.left+(isNaN(d)?0:d)-1,!r.dragBetween){var l=0==e(a.container).outerHeight()?Math.max(1,Math.round(.5+a.getItems().size()*a.draggedItem.outerWidth()/e(a.container).outerWidth()))*a.draggedItem.outerHeight():e(a.container).outerHeight()
                a.offsetLimit=e(a.container).offset(),a.offsetLimit.right=a.offsetLimit.left+e(a.container).outerWidth()-a.draggedItem.outerWidth(),a.offsetLimit.bottom=a.offsetLimit.top+l-a.draggedItem.outerHeight()}var n=a.draggedItem.height(),s=a.draggedItem.width()
            if("tr"==r.tagName?(a.draggedItem.children().each(function(){e(this).width(e(this).width())}),a.placeHolderItem=a.draggedItem.clone().attr("data-placeholder",!0),a.draggedItem.after(a.placeHolderItem),a.placeHolderItem.children().each(function(){e(this).css({borderWidth:0,width:e(this).width()+1,height:e(this).height()+1}).html("&nbsp;")})):(a.draggedItem.after(r.placeHolderTemplate),a.placeHolderItem=a.draggedItem.next().css({height:n,width:s}).attr("data-placeholder",!0)),"td"==r.tagName){var g=a.draggedItem.closest("table").get(0)
                e("<table id='"+g.id+"' style='border-width: 0px;' class='dragSortItem "+g.className+"'><tr></tr></table>").appendTo("body").children().append(a.draggedItem)}var c=a.draggedItem.attr("style")
            a.draggedItem.attr("data-origstyle",c?c:""),a.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:n,width:s}),a.scroll={moveX:0,moveY:0,maxX:e(document).width()-e(window).width(),maxY:e(document).height()-e(window).height()},a.scroll.scrollY=window.setInterval(function(){if(r.scrollContainer!=window)return e(r.scrollContainer).scrollTop(e(r.scrollContainer).scrollTop()+a.scroll.moveY),void 0
                var t=e(r.scrollContainer).scrollTop();(a.scroll.moveY>0&&t<a.scroll.maxY||a.scroll.moveY<0&&t>0)&&(e(r.scrollContainer).scrollTop(t+a.scroll.moveY),a.draggedItem.css("top",a.draggedItem.offset().top+a.scroll.moveY+1))},10),a.scroll.scrollX=window.setInterval(function(){if(r.scrollContainer!=window)return e(r.scrollContainer).scrollLeft(e(r.scrollContainer).scrollLeft()+a.scroll.moveX),void 0
                var t=e(r.scrollContainer).scrollLeft();(a.scroll.moveX>0&&t<a.scroll.maxX||a.scroll.moveX<0&&t>0)&&(e(r.scrollContainer).scrollLeft(t+a.scroll.moveX),a.draggedItem.css("left",a.draggedItem.offset().left+a.scroll.moveX+1))},10),e(o).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),a.setPos(t.pageX,t.pageY),e(document).bind("mousemove",a.swapItems),e(document).bind("mouseup",a.dropItem),r.scrollContainer!=window&&e(window).bind("DOMMouseScroll mousewheel",a.wheel)},setPos:function(t,o){var i=o-this.offset.top,d=t-this.offset.left
            r.dragBetween||(i=Math.min(this.offsetLimit.bottom,Math.max(i,this.offsetLimit.top)),d=Math.min(this.offsetLimit.right,Math.max(d,this.offsetLimit.left)))
            var l=this.draggedItem.offsetParent().not("body").offset()
            if(null!=l&&(i-=l.top,d-=l.left),r.scrollContainer==window)o-=e(window).scrollTop(),t-=e(window).scrollLeft(),o=Math.max(0,o-e(window).height()+5)+Math.min(0,o-5),t=Math.max(0,t-e(window).width()+5)+Math.min(0,t-5)
            else{var n=e(r.scrollContainer),s=n.offset()
                o=Math.max(0,o-n.height()-s.top)+Math.min(0,o-s.top),t=Math.max(0,t-n.width()-s.left)+Math.min(0,t-s.left)}a.scroll.moveX=0==t?0:t*r.scrollSpeed/Math.abs(t),a.scroll.moveY=0==o?0:o*r.scrollSpeed/Math.abs(o),this.draggedItem.css({top:i,left:d})},wheel:function(t){if((e.browser.safari||e.browser.mozilla)&&a&&r.scrollContainer!=window){var o=e(r.scrollContainer),i=o.offset()
            if(t.pageX>i.left&&t.pageX<i.left+o.width()&&t.pageY>i.top&&t.pageY<i.top+o.height()){var d=t.detail?5*t.detail:t.wheelDelta/-2
                o.scrollTop(o.scrollTop()+d),t.preventDefault()}}},buildPositionTable:function(){var t=[]
            this.getItems().not([a.draggedItem[0],a.placeHolderItem[0]]).each(function(r){var o=e(this).offset()
                o.right=o.left+e(this).outerWidth(),o.bottom=o.top+e(this).outerHeight(),o.elm=this,t[r]=o}),this.pos=t},dropItem:function(){if(null!=a.draggedItem){var t=a.draggedItem.attr("data-origstyle")
            if(a.draggedItem.attr("style",t),""==t&&a.draggedItem.removeAttr("style"),a.draggedItem.removeAttr("data-origstyle"),a.styleDragHandlers(!0),a.placeHolderItem.before(a.draggedItem),a.placeHolderItem.remove(),e("[data-droptarget], .dragSortItem").remove(),window.clearInterval(a.scroll.scrollY),window.clearInterval(a.scroll.scrollX),a.draggedItem.attr("data-origpos")!=e(o).index(a)+"-"+e(a.container).children().index(a.draggedItem)&&0==r.dragEnd.apply(a.draggedItem)){var i=a.draggedItem.attr("data-origpos").split("-"),d=e(o[i[0]].container).children().not(a.draggedItem).eq(i[1])
                d.size()>0?d.before(a.draggedItem):0==i[1]?e(o[i[0]].container).prepend(a.draggedItem):e(o[i[0]].container).append(a.draggedItem)}return a.draggedItem.removeAttr("data-origpos"),a.draggedItem=null,e(document).unbind("mousemove",a.swapItems),e(document).unbind("mouseup",a.dropItem),r.scrollContainer!=window&&e(window).unbind("DOMMouseScroll mousewheel",a.wheel),!1}},swapItems:function(t){if(null==a.draggedItem)return!1
            a.setPos(t.pageX,t.pageY)
            for(var d=a.findPos(t.pageX,t.pageY),l=a,n=0;-1==d&&r.dragBetween&&n<o.length;n++)d=o[n].findPos(t.pageX,t.pageY),l=o[n]
            if(-1==d)return!1
            var s=function(){return e(l.container).children().not(l.draggedItem)},g=s().not(r.itemSelector).each(function(){this.idx=s().index(this)})
            return null==i||i.top>a.draggedItem.offset().top||i.left>a.draggedItem.offset().left?e(l.pos[d].elm).before(a.placeHolderItem):e(l.pos[d].elm).after(a.placeHolderItem),g.each(function(){var t=s().eq(this.idx).get(0)
                this!=t&&s().index(this)<this.idx?e(this).insertAfter(t):this!=t&&e(this).insertBefore(t)}),e(o).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),i=a.draggedItem.offset(),!1},findPos:function(e,t){for(var r=0;r<this.pos.length;r++)if(this.pos[r].left<e&&this.pos[r].right>e&&this.pos[r].top<t&&this.pos[r].bottom>t)return r
            return-1},createDropTargets:function(){r.dragBetween&&e(o).each(function(){var t=e(this.container).find("[data-placeholder]"),o=e(this.container).find("[data-droptarget]")
            t.size()>0&&o.size()>0?o.remove():0==t.size()&&0==o.size()&&("td"==r.tagName?e(r.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):e(this.container).append(a.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),a.placeHolderItem.attr("data-placeholder",!0))})}}
        l.init(),o.push(l)}),this},e.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}}(jQuery)
